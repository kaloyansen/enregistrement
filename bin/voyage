#!/usr/bin/env python

import mido
import subprocess
from pydub import AudioSegment
# from pydub.utils import which

# AudioSegment.converter = which("ffmpeg")




def change_midi_instrument(midi_file, output_midi, program_number=0):
    """Change the instrument (program number) in a MIDI file."""
    mid = mido.MidiFile(midi_file)
    
    for track in mid.tracks:
        for msg in track:
            if msg.type == 'program_change':
                msg.program = program_number  # Change instrument

    mid.save(output_midi)

def midi_to_mp3(midi_file, soundfont, mp3_file, title="Unknown", artist="Unknown"):
    """Convert MIDI to MP3 using FluidSynth and add metadata."""
    wav_file = "temp.wav"
    subprocess.run(["fluidsynth", "-ni", soundfont, midi_file, "-F", wav_file, "-r", "44100"], check=True)
    audio = AudioSegment.from_wav(wav_file)
    audio.export(mp3_file, format="mp3", tags={"title": title, "artist": artist})
    subprocess.run(["rm", wav_file])


def increase_volume(input_mp3, output_mp3, db_increase=5):

    audio = AudioSegment.from_file(input_mp3, format="mp3")
    louder_audio = audio + db_increase
    louder_audio.export(output_mp3, format="mp3")


original_midi = "medi.mid"
modified_midi = "modified.mid"
mp3_out = "py.mp3"
mp3_aux = "py.mp3.aux"
soundfont_path = "/usr/share/soundfonts/FluidR3_GM.sf2"

change_midi_instrument(original_midi, modified_midi, program_number=10)  # Change to instrument 10
midi_to_mp3(modified_midi, soundfont_path, mp3_aux, title="My MIDI Song", artist="My Name")
increase_volume(mp3_aux, mp3_out, 10)

print(f"converted {original_midi} to {mp3_out} with instrument 10.")
